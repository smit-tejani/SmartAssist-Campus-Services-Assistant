<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartAssist Chat | TAMUCC Campus Assistant</title>

  <!-- Poppins Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Leaflet CSS for Maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
        crossorigin=""/>
  
  <!-- Leaflet Routing Machine CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            tamuccBlue: '#0067A5',
            tamuccTeal: '#00A99D',
            tamuccLight: '#00AEEF',
            tamuccGray: '#f5f7fa',
          },
          fontFamily: {
            sans: ['Poppins', 'sans-serif'],
          }
        }
      }
    }
  </script>
  
  <style>
    * {
      font-family: 'Poppins', sans-serif;
    }
  </style>
</head>

<body class="bg-tamuccGray min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-white border-b border-gray-200 shadow-sm sticky top-0 z-50">
    <div class="max-w-7xl mx-auto flex justify-between items-center px-6 py-4">
      <div class="flex items-center space-x-3">
        <img src="{{ url_for('static', path='assets/images/logo.png') }}"
          alt="SmartAssist Logo"
          class="h-10 w-10 object-contain rounded-lg shadow-sm">
        <div>
          <h1 class="text-xl font-semibold text-gray-800">SmartAssist</h1>
          <p class="text-xs text-gray-500">TAMUCC Campus Assistant</p>
        </div>
      </div>

      <div class="flex items-center space-x-4">
        <button id="end-live-chat"
                class="hidden text-sm bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition font-medium">
          End Live Chat
        </button>

        <button id="clear-chat"
                class="text-sm bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition font-medium">
          Clear Chat
        </button>

        <a id="back-home-link" href="/guest_home" class="text-sm text-tamuccBlue hover:text-tamuccTeal transition font-medium">
          ‚Üê Back to Home
        </a>
      </div>
    </div>
  </header>

  <!-- Chat Container -->
    <!-- Chat Container -->
  <main class="flex-grow flex justify-center px-4 py-6 max-w-7xl mx-auto w-full">
    <div class="w-full max-w-5xl bg-white rounded-xl shadow-lg border border-gray-200 flex flex-col h-[calc(100vh-160px)] overflow-hidden">

      <!-- Chat Header -->
      <div class="bg-gradient-to-r from-tamuccBlue to-tamuccTeal text-white px-6 py-4 flex justify-between items-center rounded-t-xl">
        <div class="flex items-center space-x-3">
          <div class="h-3 w-3 bg-green-400 rounded-full animate-pulse shadow-lg"></div>
          <h2 class="font-semibold text-lg">SmartAssist Virtual Assistant</h2>
        </div>
        <span id="live-status" class="hidden text-xs bg-white/20 px-3 py-1.5 rounded-full font-medium">üü¢ Live Chat Active</span>
      </div>

      <!-- Queue Timer (appears only after escalate) -->
      <div id="queue-timer" class="hidden text-sm text-amber-700 bg-amber-50 border-b border-amber-200 px-6 py-3 font-medium">
        ‚è≥ Connecting you to an admin‚Ä¶
      </div>

      <!-- Single Chat Window -->
      <div id="chat-window" class="flex-1 overflow-y-auto p-6 space-y-4 bg-gray-50">
        <div class="flex items-start space-x-3">
          <div class="w-10 h-10 bg-gradient-to-br from-tamuccBlue to-tamuccTeal rounded-full flex items-center justify-center text-white font-bold shadow-md flex-shrink-0">S</div>
          <div class="bg-white px-5 py-3 rounded-2xl rounded-tl-sm shadow-sm text-gray-800 max-w-[75%] border border-gray-100">
            <p>üëã Hi! I'm <strong class="text-tamuccBlue">SmartAssist</strong>. How can I help you today?</p>
          </div>
        </div>
      </div>

      <!-- Typing Indicator -->
      <div id="typing" class="hidden px-6 py-3 bg-gray-50 border-t border-gray-200">
        <div class="flex space-x-2 items-center text-gray-500">
          <span class="dot bg-tamuccTeal w-2 h-2 rounded-full animate-bounce"></span>
          <span class="dot bg-tamuccTeal w-2 h-2 rounded-full animate-bounce [animation-delay:0.2s]"></span>
          <span class="dot bg-tamuccTeal w-2 h-2 rounded-full animate-bounce [animation-delay:0.4s]"></span>
          <p class="text-sm ml-2 font-medium">SmartAssist is typing...</p>
        </div>
      </div>

      <!-- Single Input Area (used by both bot & live chat) -->
      <div class="border-t border-gray-200 bg-white p-5 flex items-center space-x-3 rounded-b-xl">
        <input id="chat-input" type="text" placeholder="Ask me anything about campus services..." 
               class="flex-grow bg-gray-50 rounded-xl px-5 py-3.5 text-sm focus:outline-none focus:ring-2 focus:ring-tamuccTeal border border-gray-200 transition">
        <button id="send-btn" class="bg-gradient-to-r from-tamuccBlue to-tamuccTeal text-white px-6 py-3.5 rounded-xl hover:shadow-lg transition font-semibold flex items-center justify-center min-w-[56px]">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
          </svg>
        </button>
      </div>
    </div>
  </main>

  <!-- MD libs BEFORE the inline script -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  
  <!-- Leaflet JS for Maps -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
          crossorigin=""></script>
  
  <!-- Leaflet Routing Machine JS -->
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

  <script>
    const chatWindow   = document.getElementById('chat-window');
    const chatInput    = document.getElementById('chat-input');
    const sendBtn      = document.getElementById('send-btn');
    const clearChat    = document.getElementById('clear-chat');
    const typingIndicator = document.getElementById('typing');
    const endLiveBtn   = document.getElementById('end-live-chat');
    const liveStatus   = document.getElementById('live-status');
    const queueTimerEl = document.getElementById('queue-timer');
    const backHomeLink = document.getElementById('back-home-link');

    // ---------- Set Back to Home link based on user role ----------
    async function setBackHomeLink() {
      try {
        const response = await fetch('/api/user');
        if (response.ok) {
          const user = await response.json();
          // User is logged in - redirect based on role
          if (user.role === 'student') {
            backHomeLink.href = '/student_home';
          } else if (user.role === 'admin') {
            backHomeLink.href = '/admin_home';
          } else if (user.role === 'staff') {
            backHomeLink.href = '/staff_home';
          } else {
            backHomeLink.href = '/guest_home';
          }
        } else {
          // User not logged in - go to guest home
          backHomeLink.href = '/guest_home';
        }
      } catch (error) {
        // Error or not logged in - default to guest home
        backHomeLink.href = '/guest_home';
      }
    }
    
    // Call on page load
    setBackHomeLink();

    // ---------- Persistent Session ----------
    let sessionId = localStorage.getItem('student_session_id');
    if (!sessionId) {
      sessionId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now());
      localStorage.setItem('student_session_id', sessionId);
    }

    // ---------- Live chat state ----------
    let isLiveChat = false;

    // ---------- WebSocket (lazy: open only after escalate) ----------
    let ws = null;
    function connectStudentSocket() {
      if (ws && ws.readyState === WebSocket.OPEN) return;
      ws = new WebSocket(`${location.origin.replace('http', 'ws')}/ws/student/${sessionId}`);

      ws.onopen = () => console.log('Connected to live chat WebSocket');

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === 'message') {
          if (data.sender === 'admin') appendMessage('admin', data.message);
        }

        if (data.type === 'status' && data.status === 'live') {
          stopQueueTimer();
          liveStatus.classList.remove('hidden');
          appendMessage('system', 'An admin has joined the chat.');
        }

        if (data.type === 'queued_ping') {
          updateQueuePosition(data.queue_position);
        }
      };

      ws.onclose = () => {
        if (isLiveChat) {
          appendMessage('system', 'Live chat disconnected. You can try reconnecting.');
          leaveLiveChatUI();
        }
      };

      ws.onerror = (err) => console.error('WebSocket error:', err);
    }

    function updateQueuePosition(position) {
      const queueTimerEl = document.getElementById('queue-timer');
      if (position) {
        queueTimerEl.textContent = `Connecting you to an admin‚Ä¶ You are #${position} in the queue`;
        queueTimerEl.classList.remove('hidden');
      } else {
        queueTimerEl.textContent = 'Connecting you to an admin‚Ä¶';
      }
    }

    // ---------- Timer helpers ----------
    let _queueTimer = null, _queueEndAt = null;
    function startQueueTimer(seconds = 300) { // Default to 5 minutes
      console.log("Starting queue timer for", seconds, "seconds");
      _queueEndAt = Date.now() + seconds * 1000;
      renderTimer();
      queueTimerEl.classList.remove('hidden'); // Ensure the timer element is visible
      _queueTimer = setInterval(() => {
        console.log("Rendering timer...");
        renderTimer();
      }, 500);
    }
    function stopQueueTimer() {
      if (_queueTimer) clearInterval(_queueTimer);
      _queueTimer = null; _queueEndAt = null;
      queueTimerEl.classList.add('hidden');
    }
    function renderTimer() {
      if (!_queueEndAt) {
        console.log("_queueEndAt is not set");
        return;
      }
      const remain = Math.max(0, Math.ceil((_queueEndAt - Date.now()) / 1000));
      const minutes = Math.floor(remain / 60);
      const seconds = remain % 60;
      console.log(`Time remaining: ${minutes}:${seconds}`);
      queueTimerEl.textContent = `Connecting you to an admin‚Ä¶ ${minutes}:${seconds.toString().padStart(2, '0')}`;
      queueTimerEl.classList.remove('hidden');
      if (remain <= 0) {
        stopQueueTimer();
        queueTimerEl.textContent = "Still waiting for an admin. Thank you for your patience.";
      }
    }

    // ---------- UI helpers ----------
    function avatar(letter, color='from-tamuccBlue to-tamuccTeal') {
      return `<div class="w-10 h-10 bg-gradient-to-br ${color} rounded-full flex items-center justify-center text-white font-bold shadow-md flex-shrink-0">${letter}</div>`;
    }
    function escapeHTML(s) { return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function renderMarkdown(md) {
      try {
        const html = marked.parse(md, { mangle: false, headerIds: false });
        return DOMPurify.sanitize(html);
      } catch { 
        const div = document.createElement('div'); div.textContent = md || ""; return div.innerHTML;
      }
    }
    function enhanceLinks(el) {
      el.querySelectorAll('a').forEach(a => {
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.classList.add('text-tamuccTeal','underline','hover:text-tamuccLight','font-medium');
      });
    }

    function appendMessage(role, text, opts = {}) {
      const row = document.createElement('div');
      row.className = `flex mb-4 ${role === 'user' ? 'justify-end' : 'justify-start'}`;

      const time = new Date().toLocaleString();
      const chipsId = `fu_${Date.now()}_${Math.random().toString(36).slice(2,8)}`;

      if (role === 'bot') {
        const html = renderMarkdown(text);
        row.innerHTML = `
          ${avatar('S')}
          <div class="bg-white px-5 py-3 rounded-2xl rounded-tl-sm shadow-sm text-gray-800 max-w-[75%] border border-gray-100">
            <div class="prose prose-sm max-w-none">${html}</div>
            <div class="text-[10px] text-gray-400 text-right mt-2">${time}</div>
            <div id="${chipsId}" class="mt-3 flex flex-wrap gap-2"></div>
          </div>`;
        enhanceLinks(row);

        // per-message followups
        if (Array.isArray(opts.followups) && opts.followups.length) {
          const area = row.querySelector(`#${chipsId}`);
          opts.followups.forEach(sug => {
            const btn = document.createElement('button');
            btn.className = 'inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-200 bg-white hover:bg-gray-50 hover:border-tamuccTeal text-sm font-medium transition shadow-sm';
            btn.textContent = sug.label || 'Follow up';
            btn.onclick = async () => {
              area.innerHTML = '';
              area.classList.add('hidden');
              await onFollowupClick(sug);
            };
            area.appendChild(btn);
          });
        }
      } else if (role === 'user') {
        row.classList.add('justify-end');
        row.innerHTML = `
          <div class="bg-gradient-to-r from-tamuccBlue to-tamuccTeal text-white px-5 py-3 rounded-2xl rounded-tr-sm shadow-sm max-w-[75%]">
            <p>${escapeHTML(text)}</p>
            <div class="text-[10px] text-white/70 text-right mt-1">${time}</div>
          </div>`;
      } else if (role === 'admin') {
        row.innerHTML = `
          ${avatar('A','from-blue-500 to-blue-600')}
          <div class="bg-white px-5 py-3 rounded-2xl rounded-tl-sm shadow-sm text-gray-800 max-w-[75%] border border-blue-100">
            <span class="text-xs text-blue-600 font-semibold mr-2">üë®‚Äçüíº Admin</span>${escapeHTML(text)}
            <div class="text-[10px] text-gray-400 text-right mt-1">${time}</div>
          </div>`;
      } else if (role === 'system') {
        row.innerHTML = `
          <div class="mx-auto text-xs text-gray-600 bg-gray-100 border border-gray-200 px-4 py-2 rounded-full shadow-sm font-medium">
            ${escapeHTML(text)}
          </div>`;
      }

      chatWindow.appendChild(row);
      chatWindow.scrollTop = chatWindow.scrollHeight;

      }

    // ---------- Bot flow ----------
    async function sendToBot(text) {
      // Check if user wants to talk to admin/live support
      const adminKeywords = ['talk to admin', 'speak to admin', 'connect me to admin', 'chat with admin', 'live chat', 'human support', 'talk to someone', 'speak to someone', 'real person', 'live support', 'need admin', 'want admin', 'get admin', 'contact admin'];
      const isAdminRequest = adminKeywords.some(keyword => text.toLowerCase().includes(keyword));
      
      if (isAdminRequest) {
        appendMessage('bot', 'üë®‚Äçüíº Connecting you with an admin for live support...');
        try {
          await escalateSession();
          connectStudentSocket();
          startQueueTimer(120);
          enterLiveChatUI();
          removeLiveChatCTA();
        } catch (err) {
          console.error('Error escalating to admin:', err);
          appendMessage('bot', '‚ùå Sorry, unable to connect to live support right now. Please try again in a moment.');
        }
        return;
      }

      // Check if user wants to create a ticket
    const ticketKeywords = [
    'raise ticket',
    'raise a ticket',
    'create ticket',
    'create a ticket',
    'open ticket',
    'open a ticket',
    'support ticket',
    'help ticket',
    'issue ticket',
    'student issue',
    'report issue',
    'log complaint',
    'file complaint',
    'having issue',
    'facing issue',
    'problem with'
  ];    
    const isTicketRequest = ticketKeywords.some(keyword => text.toLowerCase().includes(keyword));
      
      if (isTicketRequest) {
        await handleTicketCreation(text);
        return;
      }

      // Check if user wants routing/directions between two locations
      const routingKeywords = ['directions from', 'route from', 'how to get from', 'navigate from', 'walk from', 'directions between', 'route between', 'get to', 'from'];
      const isRoutingRequest = routingKeywords.some(keyword => text.toLowerCase().includes(keyword)) && 
                               (text.toLowerCase().includes(' to ') || text.toLowerCase().includes(' and '));
      
      if (isRoutingRequest) {
        await handleRoutingRequest(text);
        return;
      }

      // Check if user wants map/location information
      const mapKeywords = ['map', 'location', 'where is', 'building', 'campus map', 'navigate', 'find', 'show me'];
      const isMapRequest = mapKeywords.some(keyword => text.toLowerCase().includes(keyword));
      
      if (isMapRequest) {
        await handleMapRequest(text);
        return;
      }

      typingIndicator.classList.remove('hidden');
      
      try {
        const formData = new FormData();
        formData.append('question', text);

        const res = await fetch('/chat_question', { method: 'POST', body: formData });
        const data = await res.json();
        typingIndicator.classList.add('hidden');

        // Simulate streaming by displaying the answer word by word
        await streamMessage(data.answer, data.suggested_followups || [], data.suggest_live_chat || false);

      } catch (err) {
        typingIndicator.classList.add('hidden');
        console.error('Error:', err);
        appendMessage('bot', 'Sorry, something went wrong. Please try again later.');
      }
    }

    // Function to simulate streaming effect
    async function streamMessage(fullText, followups, showLiveChatCTA) {
      const messageId = `msg_${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
      const chipsId = `fu_${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
      
      const row = document.createElement('div');
      row.className = 'flex mb-4 justify-start';
      row.id = messageId;
      
      const time = new Date().toLocaleString();
      row.innerHTML = `
        ${avatar('S')}
        <div class="bg-white px-5 py-3 rounded-2xl rounded-tl-sm shadow-sm text-gray-800 max-w-[75%] border border-gray-100">
          <div id="${messageId}-content" class="prose prose-sm max-w-none"></div>
          <div class="text-[10px] text-gray-400 text-right mt-2">${time}</div>
          <div id="${chipsId}" class="mt-3 flex flex-wrap gap-2"></div>
        </div>`;
      
      chatWindow.appendChild(row);
      chatWindow.scrollTop = chatWindow.scrollHeight;

      const contentDiv = document.getElementById(`${messageId}-content`);
      
      // Split text into words for streaming effect
      const words = fullText.split(' ');
      let currentText = '';
      
      for (let i = 0; i < words.length; i++) {
        currentText += (i > 0 ? ' ' : '') + words[i];
        contentDiv.innerHTML = renderMarkdown(currentText);
        enhanceLinks(row);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        
        // Adjust delay based on word length for more natural feel
        const delay = words[i].length > 10 ? 30 : 20;
        await new Promise(resolve => setTimeout(resolve, delay));
      }

      // Ensure final content is fully rendered
      contentDiv.innerHTML = renderMarkdown(fullText);
      enhanceLinks(row);

      // Add followup buttons after streaming is complete
      if (followups.length > 0) {
        const chipsArea = document.getElementById(chipsId);
        followups.forEach(sug => {
          const btn = document.createElement('button');
          btn.className = 'inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-200 bg-white hover:bg-gray-50 hover:border-tamuccTeal text-sm font-medium transition shadow-sm';
          btn.textContent = sug.label || 'Follow up';
          btn.onclick = async () => {
            chipsArea.innerHTML = '';
            chipsArea.classList.add('hidden');
            await onFollowupClick(sug);
          };
          chipsArea.appendChild(btn);
        });
      }

    }

    // ---------- Routing Integration ----------
    async function handleRoutingRequest(userMessage) {
      typingIndicator.classList.remove('hidden');
      
      try {
        const res = await fetch('/api/analyze_routing_request', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: userMessage })
        });
        
        const data = await res.json();
        typingIndicator.classList.add('hidden');
        
        if (data.found && data.origin && data.destination) {
          showDirections(data.origin, data.destination);
        } else {
          // Show error message
          appendMessage('bot', data.message || "I couldn't find both locations. Please try again with building names.");
        }
      } catch (err) {
        typingIndicator.classList.add('hidden');
        console.error('Error analyzing routing request:', err);
        appendMessage('bot', 'Sorry, I had trouble processing your routing request. Please try again.');
      }
    }

    function showDirections(origin, destination) {
      const mapId = `map_${Date.now()}`;
      
      const row = document.createElement('div');
      row.className = 'flex mb-3 justify-start';
      row.innerHTML = `
        ${avatar('S')}
        <div class="bg-white px-4 py-2 rounded-2xl shadow text-gray-800 max-w-[85%] w-full">
          <p class="mb-2">üó∫Ô∏è Here are the <strong>walking directions</strong> from <strong>${origin.name}</strong> to <strong>${destination.name}</strong>:</p>
          <div id="${mapId}" style="height: 450px; width: 100%; border-radius: 12px; overflow: hidden; border: 2px solid #e5e7eb;"></div>
          <div class="text-[10px] opacity-60 text-right mt-1">${new Date().toLocaleString()}</div>
        </div>`;
      
      chatWindow.appendChild(row);
      chatWindow.scrollTop = chatWindow.scrollHeight;
      
      // Initialize map with routing after DOM insertion
      setTimeout(() => initializeRoutingMap(mapId, origin, destination), 100);
    }

    function initializeRoutingMap(mapId, origin, destination) {
      // Create map centered between the two points
      const centerLat = (origin.lat + destination.lat) / 2;
      const centerLng = (origin.lng + destination.lng) / 2;
      
      const map = L.map(mapId).setView([centerLat, centerLng], 16);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);
      
      // Add markers for origin and destination
      const originMarker = L.marker([origin.lat, origin.lng], {
        icon: L.divIcon({
          className: 'custom-div-icon',
          html: "<div style='background-color:#28a745;width:30px;height:30px;border-radius:50%;border:3px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:16px;'>A</div>",
          iconSize: [30, 30],
          iconAnchor: [15, 15]
        })
      }).addTo(map);
      originMarker.bindPopup(`<strong>Start:</strong> ${origin.name}`);
      
      const destMarker = L.marker([destination.lat, destination.lng], {
        icon: L.divIcon({
          className: 'custom-div-icon',
          html: "<div style='background-color:#dc3545;width:30px;height:30px;border-radius:50%;border:3px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:16px;'>B</div>",
          iconSize: [30, 30],
          iconAnchor: [15, 15]
        })
      }).addTo(map);
      destMarker.bindPopup(`<strong>Destination:</strong> ${destination.name}`);
      
      // Add routing control
      const routingControl = L.Routing.control({
        waypoints: [
          L.latLng(origin.lat, origin.lng),
          L.latLng(destination.lat, destination.lng)
        ],
        routeWhileDragging: false,
        addWaypoints: false,
        draggableWaypoints: false,
        fitSelectedRoutes: true,
        showAlternatives: false,
        lineOptions: {
          styles: [{ color: '#007A78', weight: 5, opacity: 0.7 }]
        },
        createMarker: function() { return null; }, // Don't create default markers
        router: L.Routing.osrmv1({
          serviceUrl: 'https://router.project-osrm.org/route/v1'
        })
      }).addTo(map);
      
      // Listen for route found event to display distance/time
      routingControl.on('routesfound', function(e) {
        const routes = e.routes;
        const summary = routes[0].summary;
        
        // Convert meters to feet and miles
        const distanceMeters = summary.totalDistance;
        const distanceFeet = (distanceMeters * 3.28084).toFixed(0);
        const distanceMiles = (distanceMeters / 1609.34).toFixed(2);
        
        // Convert seconds to minutes
        const timeMinutes = Math.ceil(summary.totalTime / 60);
        
        // Add info box
        const info = L.control({position: 'topright'});
        info.onAdd = function() {
          const div = L.DomUtil.create('div', 'routing-info');
          div.style.cssText = 'background:white;padding:10px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.2);font-size:12px;';
          div.innerHTML = `
            <div style="font-weight:bold;margin-bottom:4px;color:#007A78;">üìç Walking Route</div>
            <div><strong>Distance:</strong> ${distanceFeet} ft (${distanceMiles} mi)</div>
            <div><strong>Est. Time:</strong> ${timeMinutes} min</div>
          `;
          return div;
        };
        info.addTo(map);
      });
    }

    // ---------- Map Integration ----------
    async function handleMapRequest(userMessage) {
      typingIndicator.classList.remove('hidden');
      
      try {
        const res = await fetch('/api/analyze_map_request', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: userMessage })
        });
        
        const data = await res.json();
        typingIndicator.classList.add('hidden');
        
        if (data.location) {
          showMap(data.location, data.description);
        } else {
          showCampusMap();
        }
      } catch (err) {
        typingIndicator.classList.add('hidden');
        console.error('Error analyzing map request:', err);
        showCampusMap(); // Fallback to general campus map
      }
    }

    function showMap(location, description) {
      const mapId = `map_${Date.now()}`;
      
      const row = document.createElement('div');
      row.className = 'flex mb-3 justify-start';
      row.innerHTML = `
        ${avatar('S')}
        <div class="bg-white px-4 py-2 rounded-2xl shadow text-gray-800 max-w-[85%] w-full">
          <p class="mb-2">${renderMarkdown(description || `Here's the location of **${location.name}**:`)}</p>
          <div id="${mapId}" style="height: 300px; width: 100%; border-radius: 12px; overflow: hidden; border: 2px solid #e5e7eb;"></div>
          <div class="text-[10px] opacity-60 text-right mt-1">${new Date().toLocaleString()}</div>
        </div>`;
      
      chatWindow.appendChild(row);
      chatWindow.scrollTop = chatWindow.scrollHeight;
      
      // Initialize map after DOM insertion
      setTimeout(() => initializeMap(mapId, location), 100);
    }

    function showCampusMap() {
      const mapId = `map_${Date.now()}`;
      
      const row = document.createElement('div');
      row.className = 'flex mb-3 justify-start';
      row.innerHTML = `
        ${avatar('S')}
        <div class="bg-white px-4 py-2 rounded-2xl shadow text-gray-800 max-w-[85%] w-full">
          <p class="mb-2">üìç Here's the **TAMUCC Campus Map**. Click on any building for more information:</p>
          <div id="${mapId}" style="height: 400px; width: 100%; border-radius: 12px; overflow: hidden; border: 2px solid #e5e7eb;"></div>
          <div class="text-[10px] opacity-60 text-right mt-1">${new Date().toLocaleString()}</div>
        </div>`;
      
      chatWindow.appendChild(row);
      chatWindow.scrollTop = chatWindow.scrollHeight;
      
      setTimeout(() => initializeCampusMap(mapId), 100);
    }

    function initializeMap(mapId, location) {
      const map = L.map(mapId).setView([location.lat, location.lng], 17);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);
      
      const marker = L.marker([location.lat, location.lng]).addTo(map);
      marker.bindPopup(`
        <div style="min-width: 200px;">
          <h3 style="font-weight: bold; font-size: 14px; margin-bottom: 6px; color: #007A78;">${location.name}</h3>
          ${location.address ? `<p style="font-size: 12px; color: #666; margin-bottom: 4px;">üìç ${location.address}</p>` : ''}
          ${location.description ? `<p style="font-size: 12px; color: #333;">${location.description}</p>` : ''}
          ${location.hours ? `<p style="font-size: 11px; margin-top: 6px; color: #007A78;"><b>Hours:</b> ${location.hours}</p>` : ''}
        </div>
      `).openPopup();
    }

    function initializeCampusMap(mapId) {
      // TAMUCC actual campus center coordinates
      const campusCenter = [27.7135, -97.3265];
      const map = L.map(mapId).setView(campusCenter, 16);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);
      
      // Add campus building markers
      const buildings = getCampusBuildings();
      buildings.forEach(building => {
        const marker = L.marker([building.lat, building.lng]).addTo(map);
        marker.bindPopup(`
          <div style="min-width: 200px;">
            <h3 style="font-weight: bold; font-size: 14px; margin-bottom: 6px; color: #007A78;">${building.name}</h3>
            <p style="font-size: 12px; color: #666; margin-bottom: 4px;">${building.description}</p>
            ${building.hours ? `<p style="font-size: 11px; margin-top: 6px; color: #007A78;"><b>Hours:</b> ${building.hours}</p>` : ''}
            ${building.link ? `<a href="${building.link}" target="_blank" style="display: inline-block; margin-top: 8px; font-size: 11px; color: #007A78; text-decoration: underline;">üìç More Info</a>` : ''}
          </div>
        `);
      });
    }

    function getCampusBuildings() {
      // TAMUCC Campus Buildings with accurate coordinates from Google Maps
      return [
        {
          name: "Mary and Jeff Bell Library",
          lat: 27.713788736691168,
          lng: -97.32474868648656,
          description: "Main campus library with study spaces and resources",
          hours: "Mon-Thu 7:30am-midnight, Fri 7:30am-6pm",
        },
        {
          name: "University Center (UC)",
          lat: 27.712071037382053,
          lng: -97.3257065414334,
          description: "Student life hub with dining, bookstore, and Island Grille",
          hours: "Mon-Fri 7am-10pm, Sat-Sun 10am-8pm",
        },
        {
          name: "Islander Dining",
          lat: 27.711621676963894,
          lng: -97.32258737277509,
          description: "Campus dining hall with various meal options",
          hours: "Mon-Fri 7am-8pm, Sat-Sun 10am-7pm",
        },
        {
          name: "Natural Resources Center (NRC)",
          lat: 27.715332468715157,
          lng: -97.32880933649331,
          description: "College of Science and Engineering, Computer Science",
          hours: "Mon-Fri 8am-5pm",
        },
        {
          name: "Corpus Christi Hall (CCH)",
          lat: 27.71516058584113,
          lng: -97.32370567166191,
          description: "Academic building with classrooms and faculty offices",
          hours: "Mon-Fri 7am-10pm",
        },
        {
          name: "Student Services Center",
          lat: 27.71374042156452,
          lng: -97.32390201020142,
          description: "Admissions, registrar, financial aid, and student services",
          hours: "Mon-Fri 8am-5pm",
        },
        {
          name: "Bay Hall",
          lat: 27.713613491472024,
          lng: -97.32348514338884,
          description: "Academic and administrative building",
          hours: "Mon-Fri 8am-5pm",
        },
        {
          name: "Center for the Sciences",
          lat: 27.712809298665885,
          lng: -97.32486990268086,
          description: "Science labs and research facilities",
          hours: "Mon-Fri 8am-5pm",
        },
        {
          name: "College of Education and Human Development",
          lat: 27.713186318706956,
          lng: -97.32428916719182,
          description: "Education programs and teacher preparation",
          hours: "Mon-Fri 8am-5pm",
        },
        {
          name: "Faculty Center",
          lat: 27.712820723536026,
          lng: -97.32358260567656,
          description: "Faculty offices and meeting spaces",
          hours: "Mon-Fri 8am-5pm",
        },
        {
          name: "Dugan Wellness Center",
          lat: 27.711601112024837,
          lng: -97.32413753070178,
          description: "Student health services and counseling",
          hours: "Mon-Fri 8am-5pm",
        },
        {
          name: "College of Business",
          lat: 27.714591440638948,
          lng: -97.32466461335527,
          description: "College of Business and entrepreneurship programs",
          hours: "Mon-Fri 8am-5pm",
        },
        {
          name: "Tidal Hall",
          lat: 27.715529412703646,
          lng: -97.32710819211944,
          description: "Student housing residence hall",
          hours: "24/7 for residents",
        },
        {
          name: "Harte Research Institute",
          lat: 27.713459500631362,
          lng: -97.32815759566772,
          description: "Gulf of Mexico research and marine science",
          hours: "Mon-Fri 8am-5pm",
        },
        {
          name: "University Counseling Center",
          lat: 27.712490577148014,
          lng: -97.32168122550681,
          description: "Mental health and counseling services for students",
          hours: "Mon-Fri 8am-5pm",
        }
      ];
    }

    // ---------- Ticket Creation Flow ----------
    let ticketData = {};
    let ticketStep = 0;

    async function handleTicketCreation(initialMessage) {
      ticketData = {
        description: initialMessage,
        category: '',
        priority: '',
        subject: ''
      };
      ticketStep = 0;

      appendMessage('bot', "I'll help you create a ticket for your issue. Let me gather some information...");
      
      // Use AI to extract initial information
      await analyzeTicketRequest(initialMessage);
    }

    async function analyzeTicketRequest(userMessage) {
      typingIndicator.classList.remove('hidden');
      
      try {
        const res = await fetch('/api/analyze_ticket', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: userMessage })
        });
        
        const data = await res.json();
        typingIndicator.classList.add('hidden');
        
        // Populate ticket data with AI analysis
        ticketData.subject = data.subject || '';
        ticketData.category = data.category || '';
        ticketData.priority = data.priority || 'Medium';
        ticketData.description = userMessage;
        
        // Show extracted information and ask for confirmation
        showTicketPreview();
      } catch (err) {
        typingIndicator.classList.add('hidden');
        console.error('Error analyzing ticket:', err);
        // Fallback to manual entry
        askForTicketSubject();
      }
    }

    function showTicketPreview() {
      const previewHTML = `
        **Here's the ticket I've prepared for you:**
        
        üìã **Subject**: ${ticketData.subject || 'Not specified'}
        üè∑Ô∏è **Category**: ${ticketData.category || 'General'}
        ‚ö° **Priority**: ${ticketData.priority || 'Medium'}
        üìù **Description**: ${ticketData.description}
        
        Is this information correct?
      `;
      
      const followups = [
        { label: '‚úÖ Yes, submit this ticket', payload: { type: 'action', action: 'submit_ticket' } },
        { label: '‚úèÔ∏è Edit subject', payload: { type: 'action', action: 'edit_subject' } },
        { label: 'üè∑Ô∏è Change category', payload: { type: 'action', action: 'edit_category' } },
        { label: '‚ö° Change priority', payload: { type: 'action', action: 'edit_priority' } },
        { label: '‚ùå Cancel', payload: { type: 'action', action: 'cancel_ticket' } }
      ];
      
      appendMessage('bot', previewHTML, { followups });
    }

    function askForTicketSubject() {
      appendMessage('bot', "What should be the subject of your ticket?");
      ticketStep = 1; // Waiting for subject
    }

    function askForTicketCategory() {
      const categoryOptions = [
        { label: 'üíª Technical Support', payload: { type: 'action', action: 'set_category', value: 'Technical Support' } },
        { label: 'üìö Academic', payload: { type: 'action', action: 'set_category', value: 'Academic' } },
        { label: 'üí∞ Financial', payload: { type: 'action', action: 'set_category', value: 'Financial' } },
        { label: 'üè† Housing', payload: { type: 'action', action: 'set_category', value: 'Housing' } },
        { label: 'üìù Registration', payload: { type: 'action', action: 'set_category', value: 'Registration' } },
        { label: 'üîß Other', payload: { type: 'action', action: 'set_category', value: 'Other' } }
      ];
      
      appendMessage('bot', "Please select a category for your ticket:", { followups: categoryOptions });
    }

    function askForTicketPriority() {
      const priorityOptions = [
        { label: 'üî¥ High', payload: { type: 'action', action: 'set_priority', value: 'High' } },
        { label: 'üü° Medium', payload: { type: 'action', action: 'set_priority', value: 'Medium' } },
        { label: 'üü¢ Low', payload: { type: 'action', action: 'set_priority', value: 'Low' } }
      ];
      
      appendMessage('bot', "What's the priority of this issue?", { followups: priorityOptions });
    }

    async function submitTicket() {
      typingIndicator.classList.remove('hidden');
      
      try {
        const res = await fetch('/api/tickets', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(ticketData)
        });
        
        typingIndicator.classList.add('hidden');
        
        if (res.ok) {
          const result = await res.json();
          appendMessage('bot', `‚úÖ **Ticket created successfully!**\n\nYour ticket ID is: **${result.ticket_id}**\n\nYou can track its status in your student dashboard. An admin will review and assign it to the appropriate staff member soon.`);
          
          // Reset ticket data
          ticketData = {};
          ticketStep = 0;
        } else {
          appendMessage('bot', '‚ùå Sorry, there was an error creating your ticket. Please try again or contact support directly.');
        }
      } catch (err) {
        typingIndicator.classList.add('hidden');
        console.error('Error submitting ticket:', err);
        appendMessage('bot', '‚ùå Sorry, there was an error creating your ticket. Please try again or contact support directly.');
      }
    }

    // ---------- Escalation flow ----------
    async function escalateSession() {
      // Try to get student information if logged in
      let studentInfo = {
        student_name: null,
        student_email: null
      };
      
      try {
        const userRes = await fetch('/api/user');
        if (userRes.ok) {
          const user = await userRes.json();
          studentInfo.student_name = user.full_name || user.email || null;
          studentInfo.student_email = user.email || null;
        }
      } catch (err) {
        console.log('User not logged in, proceeding as guest');
      }
      
      const res = await fetch(`/api/chat/${sessionId}/escalate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(studentInfo)
      });
      if (!res.ok) throw new Error('Failed to escalate');
    }

    function enterLiveChatUI() {
      isLiveChat = true;
      endLiveBtn.classList.remove('hidden');
      appendMessage('system', 'Connecting with live support team‚Ä¶');
    }

    function removeLiveChatCTA() {
      document.querySelectorAll('#start-live-chat').forEach(btn => {
        const wrap = btn.parentElement;
        if (wrap) wrap.remove(); else btn.remove();
      });
    }

    function leaveLiveChatUI() {
      isLiveChat = false;
      endLiveBtn.classList.add('hidden');
      liveStatus.classList.add('hidden');
      stopQueueTimer();
      appendMessage('system', 'Live chat ended. You can continue with the assistant.');
    }

    async function onFollowupClick(sug) {
      if (sug?.payload?.type === 'faq' && sug.payload.query) {
        appendMessage('user', sug.payload.query);
        await sendToBot(sug.payload.query);
      } else if (sug?.payload?.type === 'action') {
        // Handle ticket creation actions
        if (sug.payload.action === 'submit_ticket') {
          await submitTicket();
        } else if (sug.payload.action === 'edit_subject') {
          askForTicketSubject();
        } else if (sug.payload.action === 'edit_category') {
          askForTicketCategory();
        } else if (sug.payload.action === 'edit_priority') {
          askForTicketPriority();
        } else if (sug.payload.action === 'set_category') {
          ticketData.category = sug.payload.value;
          appendMessage('user', sug.payload.value);
          showTicketPreview();
        } else if (sug.payload.action === 'set_priority') {
          ticketData.priority = sug.payload.value;
          appendMessage('user', sug.payload.value);
          showTicketPreview();
        } else if (sug.payload.action === 'cancel_ticket') {
          ticketData = {};
          ticketStep = 0;
          appendMessage('bot', 'Ticket creation cancelled. How else can I help you?');
        } else if (sug.payload.action === 'escalate') {
          try {
            await escalateSession();         // 1) mark queued
            connectStudentSocket();          // 2) open WS
            startQueueTimer(120);            // 3) show countdown
            enterLiveChatUI();               // 4) flip UI state
          } catch (e) {
            console.error(e);
            alert('Unable to start live chat right now. Please try again.');
          }
        }
      }
    }

    // ---------- Live chat send ----------
    function sendToLiveChat(text) {
      try {
        if (!ws || ws.readyState !== WebSocket.OPEN) throw new Error('WS not open');
        ws.send(JSON.stringify({ message: text }));
      } catch (e) {
        appendMessage('system', 'Could not send message. Please try again.');
      }
    }

    // ---------- Send button / input ----------
    async function onSend() {
      const text = chatInput.value.trim();
      if (!text) return;

      if (isLiveChat) {
        appendMessage('user', text);
        chatInput.value = '';
        sendToLiveChat(text);
        return;
      }

      // Bot mode - check if we're in ticket creation flow
      if (ticketStep === 1) {
        // User is providing subject
        ticketData.subject = text;
        appendMessage('user', text);
        chatInput.value = '';
        ticketStep = 0;
        showTicketPreview();
        return;
      }

      // Normal bot interaction
      appendMessage('user', text);
      chatInput.value = '';
      await sendToBot(text);
    }
    sendBtn.addEventListener('click', onSend);
    chatInput.addEventListener('keypress', (e) => (e.key === 'Enter') && onSend());

    // Escalate via legacy CTA button (if rendered)
    document.addEventListener('click', async (e) => {
      if (e.target && e.target.id === 'start-live-chat') {
        e.preventDefault();
        e.target.setAttribute('disabled', 'disabled');
        removeLiveChatCTA();
        try {
          await escalateSession();
          connectStudentSocket();
          startQueueTimer(120);
          enterLiveChatUI();
        } catch (err) {
          console.error(err);
          alert('Unable to start live chat right now. Please try again.');
        }
      }
    });

    // End live chat
    endLiveBtn.addEventListener('click', async () => {
      try { await fetch(`/api/chat/${sessionId}/end`, { method: 'POST' }); } catch {}
      // optionally close socket
      try { ws?.close(); } catch {}
      leaveLiveChatUI();
    });


    // Clear transcript
    clearChat.addEventListener('click', () => {
      chatWindow.innerHTML = `
        <div class="flex items-start space-x-3">
          <div class="w-10 h-10 bg-tamuccTeal rounded-full flex items-center justify-center text-white font-bold">S</div>
          <div class="bg-white px-4 py-2 rounded-2xl shadow text-gray-800 max-w-[70%]">
            üëã Hi! I‚Äôm <strong>SmartAssist</strong>. How can I help you today?
          </div>
        </div>`;
      typingIndicator.classList.add('hidden');
      stopQueueTimer();
      liveStatus.classList.add('hidden');
    });
  </script>
</body>
</html>
