<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartAssist Chat | TAMUCC Campus Assistant</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            tamuccBlue: '#003366',
            tamuccTeal: '#007A78',
            tamuccLight: '#00AEEF',
            tamuccGray: '#F4F7FA',
          }
        }
      }
    }
  </script>
</head>

<body class="bg-gradient-to-br from-tamuccBlue via-tamuccTeal to-tamuccLight min-h-screen flex flex-col">

  <!-- Header -->
  <header class="backdrop-blur-md bg-white/10 border-b border-white/20 text-white shadow-lg">
    <div class="max-w-6xl mx-auto flex justify-between items-center px-6 py-4">
      <div class="flex items-center space-x-3">
      <img src="{{ url_for('static', path='assets/images/logo.png') }}"
        alt="SmartAssist Logo"
        class="h-10 w-10 object-contain rounded-lg shadow-md border border-gray-200">
        <div>
          <h1 class="text-2xl font-semibold tracking-wide">SmartAssist</h1>
          <p class="text-xs text-white/70">TAMUCC Campus Assistant</p>
        </div>
      </div>
      <div class="flex items-center space-x-4">
        <span class="bg-green-500 text-xs px-3 py-1 rounded-full animate-pulse">Online</span>
        <a href="/student_home" class="hover:text-tamuccLight text-sm">Home</a>
      </div>
    </div>
  </header>

  <!-- Chat Container -->
  <main class="flex-grow flex justify-center py-10 px-4">
    <div class="w-full max-w-4xl bg-white/80 backdrop-blur-md rounded-2xl shadow-2xl border border-gray-200 flex flex-col h-[calc(100vh-80px)] overflow-hidden">

      <!-- Chat Header -->
      <div class="bg-tamuccTeal text-white px-6 py-4 flex justify-between items-center">
        <div class="flex items-center space-x-2">
          <div class="h-3 w-3 bg-green-400 rounded-full animate-pulse"></div>
          <h2 class="font-semibold text-lg">SmartAssist Virtual Assistant</h2>
        </div>
        <button id="clear-chat" class="text-sm bg-white/20 px-3 py-1 rounded-lg hover:bg-white hover:text-tamuccTeal transition">
          Clear Chat
        </button>
      </div>

      <!-- Chat Window -->
      <div id="chat-window" class="flex-1 overflow-y-auto p-6 space-y-4 bg-tamuccGray">
        <div class="flex items-start space-x-3">
          <div class="w-10 h-10 bg-tamuccTeal rounded-full flex items-center justify-center text-white font-bold">S</div>
          <div class="bg-white px-4 py-2 rounded-2xl shadow text-gray-800 max-w-[70%]">
            ðŸ‘‹ Hi! Iâ€™m <strong>SmartAssist</strong>. How can I help you today?
          </div>
        </div>
      </div>

      <!-- Typing Indicator -->
      <div id="typing" class="hidden px-6 py-2 bg-tamuccGray border-t border-gray-200">
        <div class="flex space-x-2 items-center text-gray-500">
          <span class="dot bg-gray-400 w-2 h-2 rounded-full animate-bounce"></span>
          <span class="dot bg-gray-400 w-2 h-2 rounded-full animate-bounce [animation-delay:0.2s]"></span>
          <span class="dot bg-gray-400 w-2 h-2 rounded-full animate-bounce [animation-delay:0.4s]"></span>
          <p class="text-sm ml-2">SmartAssist is typing...</p>
        </div>
      </div>

      <!-- Input Area -->
      <div class="border-t border-gray-200 bg-white p-4 flex items-center space-x-3">
        <input id="chat-input" type="text" placeholder="Ask me anything about campus services..." 
               class="flex-grow bg-gray-100 rounded-full px-5 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-tamuccTeal">
        <button id="send-btn" class="bg-tamuccTeal text-white px-5 py-3 rounded-full hover:bg-tamuccLight transition font-semibold">
          âž¤
        </button>
      </div>

      <!-- Live Chat Container -->
      <div id="live-chat-container" class="hidden flex flex-col border-t border-gray-200 bg-gray-50 p-4 space-y-3 flex-1 min-h-0">
        <div id="live-chat-window" class="flex-1 overflow-y-auto p-2 space-y-2 bg-white rounded-lg shadow-inner min-h-0">
          <!-- Admin messages will appear here -->
        </div>
        <div class="flex space-x-2">
          <input id="live-chat-input" type="text" placeholder="Type your message to Admin..." 
                class="flex-grow rounded-full px-4 py-2 border focus:outline-none focus:ring-2 focus:ring-tamuccTeal">
          <button id="live-chat-send" class="bg-tamuccTeal text-white px-4 py-2 rounded-full hover:bg-tamuccLight">Send</button>
        </div>
      </div>
    </div>
  </main>

  <!-- JS -->
  <script>
    const chatWindow = document.getElementById('chat-window');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const clearChat = document.getElementById('clear-chat');
    const typingIndicator = document.getElementById('typing');

    const liveChatContainer = document.getElementById('live-chat-container');
    const liveChatWindow = document.getElementById('live-chat-window');
    const liveChatInput = document.getElementById('live-chat-input');
    const liveChatSend = document.getElementById('live-chat-send');

    // ---------- Persistent Session ----------
    let sessionId = localStorage.getItem('student_session_id');
    if (!sessionId) {
        sessionId = crypto.randomUUID();
        localStorage.setItem('student_session_id', sessionId);
    }

    // ---------- WebSocket for live chat ----------
    const ws = new WebSocket(`ws://${window.location.host}/ws/student/${sessionId}`);

    ws.onopen = () => console.log('Connected to live chat WebSocket');

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === 'message') {
            const senderClass = data.sender === 'student' ? 'text-right text-blue-600' : 'text-left text-gray-800';
            const prefix = data.sender === 'student' ? 'You: ' : 'Admin: ';
            liveChatWindow.innerHTML += `<div class="${senderClass} font-medium">${prefix}${data.message}</div>`;
            liveChatWindow.scrollTop = liveChatWindow.scrollHeight;
        }

        if (data.type === 'new_session') {
            console.log('New session:', data.session_id);
        }
    };

    ws.onclose = () => {
        liveChatWindow.innerHTML += `<div class="text-center text-gray-500 text-sm">Disconnected. Refresh to reconnect.</div>`;
    };

    ws.onerror = (err) => console.error('WebSocket error:', err);

    // ---------- Main Chat Functions ----------
    function appendMessage(message, type = 'user', showLiveChat = false) {
      const msgDiv = document.createElement('div');
      msgDiv.classList.add('flex', 'items-start', 'space-x-3');
      if (type === 'user') {
        msgDiv.classList.add('justify-end');
        msgDiv.innerHTML = `<div class="bg-tamuccTeal text-white px-4 py-2 rounded-2xl shadow max-w-[70%]">${message}</div>`;
      } else {
        msgDiv.innerHTML = `
          <div class="w-10 h-10 bg-tamuccTeal rounded-full flex items-center justify-center text-white font-bold">S</div>
          <div class="bg-white px-4 py-2 rounded-2xl shadow text-gray-800 max-w-[70%]">
            ${message}
            ${showLiveChat ? '<div class="mt-2"><a href="#" id="start-live-chat" class="text-tamuccTeal font-semibold underline">Start Live Chat with Admin</a></div>' : ''}
          </div>
        `;
      }
      chatWindow.appendChild(msgDiv);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    async function sendMessage() {
      const text = chatInput.value.trim();
      if (!text) return;
      appendMessage(text, 'user');
      chatInput.value = '';
      typingIndicator.classList.remove('hidden');

      try {
        const formData = new FormData();
        formData.append('question', text);

        const res = await fetch('/chat_question', { method: 'POST', body: formData });
        const data = await res.json();
        typingIndicator.classList.add('hidden');

        appendMessage(data.answer, 'bot', data.suggest_live_chat);
      } catch (err) {
        typingIndicator.classList.add('hidden');
        appendMessage('Sorry, something went wrong. Please try again later.', 'bot');
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', e => e.key === 'Enter' && sendMessage());

    clearChat.addEventListener('click', () => chatWindow.innerHTML = `
      <div class="flex items-start space-x-3">
        <div class="w-10 h-10 bg-tamuccTeal rounded-full flex items-center justify-center text-white font-bold">S</div>
        <div class="bg-white px-4 py-2 rounded-2xl shadow text-gray-800 max-w-[70%]">
          ðŸ‘‹ Hi! Iâ€™m <strong>SmartAssist</strong>. How can I help you today?
        </div>
      </div>
    `);

    // ---------- Start Live Chat ----------
    document.addEventListener('click', e => {
      if (e.target && e.target.id === 'start-live-chat') {
        e.preventDefault();
        liveChatContainer.classList.remove('hidden');
        liveChatWindow.innerHTML += `<div class="text-sm text-gray-500">You are now connected with a live admin.</div>`;
        liveChatWindow.scrollTop = liveChatWindow.scrollHeight;
      }
    });

    function sendLiveChatMessage() {
      const msg = liveChatInput.value.trim();
      if (!msg) return;
      ws.send(JSON.stringify({ message: msg }));
      liveChatInput.value = '';
      liveChatWindow.innerHTML += `<div class="text-right text-blue-600 font-medium">You: ${msg}</div>`;
      liveChatWindow.scrollTop = liveChatWindow.scrollHeight;
    }

    liveChatSend.addEventListener('click', sendLiveChatMessage);
    liveChatInput.addEventListener('keypress', e => e.key === 'Enter' && sendLiveChatMessage());

  </script>
</body>
</html>
