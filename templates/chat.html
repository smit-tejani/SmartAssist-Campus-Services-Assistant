<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartAssist Chat | TAMUCC Campus Assistant</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            tamuccBlue: '#003366',
            tamuccTeal: '#007A78',
            tamuccLight: '#00AEEF',
            tamuccGray: '#F4F7FA',
          }
        }
      }
    }
  </script>
</head>

<body class="bg-gradient-to-br from-tamuccBlue via-tamuccTeal to-tamuccLight min-h-screen flex flex-col">

  <!-- Header -->
  <header class="backdrop-blur-md bg-white/10 border-b border-white/20 text-white shadow-lg">
    <div class="max-w-6xl mx-auto flex justify-between items-center px-6 py-4">
      <div class="flex items-center space-x-3">
        <img src="{{ url_for('static', path='assets/images/logo.png') }}"
          alt="SmartAssist Logo"
          class="h-10 w-10 object-contain rounded-lg shadow-md border border-gray-200">
        <div>
          <h1 class="text-2xl font-semibold tracking-wide">SmartAssist</h1>
          <p class="text-xs text-white/70">TAMUCC Campus Assistant</p>
        </div>
      </div>

      <div class="flex items-center space-x-3">
        <button id="end-live-chat"
                class="hidden text-sm bg-white/20 px-3 py-1 rounded-lg hover:bg-white hover:text-tamuccTeal transition">
          End live chat
        </button>

        <button id="clear-chat"
                class="text-sm bg-white/20 px-3 py-1 rounded-lg hover:bg-white hover:text-tamuccTeal transition">
          Clear Chat
        </button>

        <a href="/student_home" class="hover:text-tamuccLight text-sm">Home</a>
      </div>
    </div>
  </header>

  <!-- Chat Container -->
  <main class="flex-grow flex justify-center py-10 px-4">
    <div class="w-full max-w-4xl bg-white/80 backdrop-blur-md rounded-2xl shadow-2xl border border-gray-200 flex flex-col h-[calc(100vh-80px)] overflow-hidden">

      <!-- Chat Header -->
      <div class="bg-tamuccTeal text-white px-6 py-4 flex justify-between items-center">
        <div class="flex items-center space-x-2">
          <div class="h-3 w-3 bg-green-400 rounded-full animate-pulse"></div>
          <h2 class="font-semibold text-lg">SmartAssist Virtual Assistant</h2>
        </div>
        <span id="live-status" class="hidden text-xs bg-white/20 px-2 py-1 rounded">Live chat connected</span>
      </div>

      <!-- Single Chat Window -->
      <div id="chat-window" class="flex-1 overflow-y-auto p-6 space-y-4 bg-tamuccGray">
        <div class="flex items-start space-x-3">
          <div class="w-10 h-10 bg-tamuccTeal rounded-full flex items-center justify-center text-white font-bold">S</div>
          <div class="bg-white px-4 py-2 rounded-2xl shadow text-gray-800 max-w-[70%]">
            üëã Hi! I‚Äôm <strong>SmartAssist</strong>. How can I help you today?
          </div>
        </div>
      </div>

      <!-- Typing Indicator -->
      <div id="typing" class="hidden px-6 py-2 bg-tamuccGray border-t border-gray-200">
        <div class="flex space-x-2 items-center text-gray-500">
          <span class="dot bg-gray-400 w-2 h-2 rounded-full animate-bounce"></span>
          <span class="dot bg-gray-400 w-2 h-2 rounded-full animate-bounce [animation-delay:0.2s]"></span>
          <span class="dot bg-gray-400 w-2 h-2 rounded-full animate-bounce [animation-delay:0.4s]"></span>
          <p class="text-sm ml-2">SmartAssist is typing...</p>
        </div>
      </div>

      <!-- Single Input Area (used by both bot & live chat) -->
      <div class="border-t border-gray-200 bg-white p-4 flex items-center space-x-3">
        <input id="chat-input" type="text" placeholder="Ask me anything about campus services..." 
               class="flex-grow bg-gray-100 rounded-full px-5 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-tamuccTeal">
        <button id="send-btn" class="bg-tamuccTeal text-white px-5 py-3 rounded-full hover:bg-tamuccLight transition font-semibold">
          ‚û§
        </button>
      </div>
    </div>
  </main>

  <!-- JS -->
  <script>
    const chatWindow = document.getElementById('chat-window');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const clearChat = document.getElementById('clear-chat');
    const typingIndicator = document.getElementById('typing');

    const endLiveBtn = document.getElementById('end-live-chat');
    const liveStatus  = document.getElementById('live-status');

    // ---------- Persistent Session ----------
    let sessionId = localStorage.getItem('student_session_id');
    if (!sessionId) {
      sessionId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now());
      localStorage.setItem('student_session_id', sessionId);
    }

    // ---------- Live chat state ----------
    let isLiveChat = false;

    // ---------- WebSocket (created immediately; used when escalated) ----------
    const ws = new WebSocket(`ws://${window.location.host}/ws/student/${sessionId}`);

    ws.onopen = () => console.log('Connected to live chat WebSocket');

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);

      if (data.type === 'message') {
        // server echoes both student/admin; only render admin here
        if (data.sender === 'admin') {
          appendMessage('admin', data.message);
        }
      }

      if (data.type === 'new_session') {
        console.log('New session:', data.session_id);
      }
    };

    ws.onclose = () => {
      if (isLiveChat) {
        appendMessage('system', 'Live chat disconnected. You can try reconnecting.');
        leaveLiveChatUI();
      }
    };

    ws.onerror = (err) => console.error('WebSocket error:', err);

    // ---------- UI helpers ----------
    function avatar(letter, color='bg-tamuccTeal') {
      return `<div class="w-10 h-10 ${color} rounded-full flex items-center justify-center text-white font-bold">${letter}</div>`;
    }

    function bubble(content, extra='') {
      return `<div class="bg-white px-4 py-2 rounded-2xl shadow text-gray-800 max-w-[70%] ${extra}">${content}</div>`;
    }

    function appendMessage(role, text, opts = {}) {
      const row = document.createElement('div');
      row.classList.add('flex', 'items-start', 'space-x-3');

      if (role === 'user') {
        row.classList.add('justify-end');
        row.innerHTML = `<div class="bg-tamuccTeal text-white px-4 py-2 rounded-2xl shadow max-w-[70%]">${text}</div>`;
      } else if (role === 'bot') {
        const html = renderMarkdown(text);        // ‚Üê convert MD to HTML
        row.innerHTML = `${avatar('S')} ${bubble(html)}`;
        enhanceLinks(row);                         // ‚Üê make links clickable & styled
      } else if (role === 'admin') {
        row.innerHTML = `${avatar('A','bg-blue-600')} ${bubble(`<span class="text-xs text-blue-600 font-semibold mr-2">Admin</span>${escapeHTML(text)}`)}`;
      } else if (role === 'system') {
        row.classList.add('w-full', 'justify-center');
        row.innerHTML = `<div class="text-xs text-gray-500">${text}</div>`;
      }
      chatWindow.appendChild(row);
      chatWindow.scrollTop = chatWindow.scrollHeight;

      // Add "Start Live Chat" affordance under bot messages when suggested
      if (opts.showLiveChatCTA) {
        const cta = document.createElement('div');
        cta.className = 'flex justify-start';
        cta.innerHTML = `
          <button id="start-live-chat"
                  class="mt-2 text-sm bg-tamuccTeal/10 text-tamuccTeal px-3 py-1 rounded-full hover:bg-tamuccTeal/20">
            Start Live Chat with Admin
          </button>`;
        chatWindow.appendChild(cta);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }
    }

    function escapeHTML(s) { return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // ---------- Bot flow ----------
    async function sendToBot(text) {
      typingIndicator.classList.remove('hidden');
      try {
        const formData = new FormData();
        formData.append('question', text);

        const res = await fetch('/chat_question', { method: 'POST', body: formData });
        const data = await res.json();
        typingIndicator.classList.add('hidden');

        // When the backend suggests escalation, show CTA in the same bubble
        appendMessage('bot', data.answer, { showLiveChatCTA: !!data.suggest_live_chat });
      } catch (err) {
        typingIndicator.classList.add('hidden');
        appendMessage('bot', 'Sorry, something went wrong. Please try again later.');
      }
    }

    // ---------- Live chat flow ----------
    const AGENT_JOIN_DELAY = 2500; // 2.5s (set to 2000‚Äì3000 if you like)

function enterLiveChatUI() {
  isLiveChat = true;

  endLiveBtn.classList.remove('hidden');
  removeLiveChatCTA();

  // 1) show immediately
  appendMessage('system', 'Connecting with live support team‚Ä¶');

  // 2) show after a short delay
  setTimeout(() => {
    appendMessage('system', 'An Agent has joined the chat.');
    // reveal the header badge only after the agent joins (optional)
    liveStatus.classList.remove('hidden');
  }, AGENT_JOIN_DELAY);
}

    
    function renderMarkdown(md) {
  const html = marked.parse(md, { mangle: false, headerIds: false });
  return DOMPurify.sanitize(html);
}
function enhanceLinks(el) {
  el.querySelectorAll('a').forEach(a => {
    a.target = '_blank';
    a.rel = 'noopener noreferrer';
    a.classList.add('text-tamuccTeal','underline','hover:text-tamuccLight');
  });
}


    

    function removeLiveChatCTA() {
        document.querySelectorAll('#start-live-chat').forEach(btn => {
          // remove the wrapper row if present so spacing also disappears
          const wrap = btn.parentElement;
          if (wrap) wrap.remove();
          else btn.remove();
        });
      }


    function leaveLiveChatUI() {
      isLiveChat = false;
      endLiveBtn.classList.add('hidden');
      liveStatus.classList.add('hidden');
      appendMessage('system', 'Live chat ended. You can continue with the assistant.');
    }

    function sendToLiveChat(text) {
        try {
          ws.send(JSON.stringify({ message: text }));
        } catch (e) {
          appendMessage('system', 'Could not send message. Please try again.');
        }
      }

      async function onSend() {
        const text = chatInput.value.trim();
        if (!text) return;

        if (isLiveChat) {
          // Live mode: render once, then send via WS
          appendMessage('user', text);
          chatInput.value = '';
          sendToLiveChat(text);
          return;
        }

        // Bot mode
        appendMessage('user', text);
        chatInput.value = '';
        await sendToBot(text);
      }


    sendBtn.addEventListener('click', onSend);
    chatInput.addEventListener('keypress', (e) => (e.key === 'Enter') && onSend());

    // escalate by clicking the inline CTA
    document.addEventListener('click', (e) => {
  if (e.target && e.target.id === 'start-live-chat') {
    e.preventDefault();
    e.target.setAttribute('disabled', 'disabled');
    removeLiveChatCTA();           // ‚Üê get it out of the DOM
    enterLiveChatUI();
  }
});


    // end live chat
    endLiveBtn.addEventListener('click', () => {
      leaveLiveChatUI();
    });

    // clear transcript
    clearChat.addEventListener('click', () => {
      chatWindow.innerHTML = `
        <div class="flex items-start space-x-3">
          <div class="w-10 h-10 bg-tamuccTeal rounded-full flex items-center justify-center text-white font-bold">S</div>
          <div class="bg-white px-4 py-2 rounded-2xl shadow text-gray-800 max-w-[70%]">
            üëã Hi! I‚Äôm <strong>SmartAssist</strong>. How can I help you today?
          </div>
        </div>`;
      typingIndicator.classList.add('hidden');
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

</body>
</html>
