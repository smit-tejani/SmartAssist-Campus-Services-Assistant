<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SmartAssist | Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins', sans-serif; }
  body { background:#f5f7fb; overflow-x:hidden; }

  /* Navbar */
  nav { display:flex; justify-content:space-between; align-items:center;
    padding:1rem 2rem; background:#0067A5; color:#fff; position:sticky; top:0; z-index:1000;
    box-shadow:0 2px 10px rgba(0,0,0,0.1); }
  nav h1 { font-size:1.6rem; font-weight:600; }
  nav .nav-links a { color:#fff; text-decoration:none; margin-left:1.5rem; font-weight:500; transition:0.3s; }
  nav .nav-links a:hover { color:#00A99D; }

  /* Container */
  .container { display:flex; min-height:calc(100vh - 70px); }
  .sidebar { width:250px; background:#fff; padding:2rem 1rem; border-right:1px solid #e0e0e0;
    display:flex; flex-direction:column; gap:1.5rem; position:sticky; top:70px; }
  .sidebar a { text-decoration:none; color:#0067A5; font-weight:500; padding:0.8rem 1rem; border-radius:8px;
    transition:0.3s; display:flex; align-items:center; gap:0.8rem; }
  .sidebar a:hover { background:#00A99D; color:#fff; }

  .content { flex:1; padding:2rem; display:flex; flex-direction:column; gap:2rem; }

  /* Hero Section */
  .hero { background:#00A99D; color:#fff; padding:2rem; border-radius:16px;
    display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;
    box-shadow:0 4px 20px rgba(0,0,0,0.1); }
  .hero h2 { font-size:1.8rem; margin-bottom:0.5rem; }
  .hero img { width:200px; max-width:100%; }

  /* Stats */
  .stats { display:flex; gap:1rem; flex-wrap:wrap; }
  .stat { flex:1; min-width:180px; background:#fff; padding:1rem 1.5rem; border-radius:12px;
    display:flex; align-items:center; justify-content:space-between;
    box-shadow:0 6px 20px rgba(0,0,0,0.05); transition:0.3s; }
  .stat:hover { transform:translateY(-5px); }

  /* Cards */
  .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:1.5rem; }
  .card { background:#fff; border-radius:16px; padding:1.5rem; box-shadow:0 6px 20px rgba(0,0,0,0.05);
    transition:0.4s; cursor:pointer; display:flex; flex-direction:column; justify-content:center; }
  .card:hover { transform:translateY(-8px); }
  .card i { font-size:2rem; color:#0067A5; margin-bottom:1rem; }

  /* Chatbot Button */
  .chatbot-btn {
    position:fixed; bottom:25px; right:25px; background:#0067A5; color:#fff;
    width:60px; height:60px; border-radius:50%; border:none;
    font-size:1.8rem; cursor:pointer; box-shadow:0 6px 20px rgba(0,0,0,0.2);
    transition:0.3s; z-index:1200;
  }
  .chatbot-btn:hover { background:#00A99D; }

  /* Live Chat Panel */
  .chat-panel {
    position:fixed; top:0; right:-450px; width:450px; height:100%;
    background:#fff; box-shadow:-3px 0 15px rgba(0,0,0,0.2);
    display:flex; flex-direction:column; transition:right 0.4s ease;
    z-index:1100;
  }
  .chat-panel.open { right:0; }

  .chat-header {
    background:#0067A5; color:#fff; padding:1rem; display:flex;
    justify-content:space-between; align-items:center;
  }
  .chat-header h3 { margin:0; font-size:1.1rem; }
  .close-chat { cursor:pointer; font-size:1.2rem; }

  .chat-body { flex:1; display:flex; min-height: 0;}
  .chat-list {
    width:40%; border-right:1px solid #eee; overflow-y:auto;
    background:#f8fafc;
  }
  .chat-list-item {
    padding:0.8rem; border-bottom:1px solid #eee; cursor:pointer;
    transition:0.2s;
  }
  .chat-list-item:hover, .chat-list-item.active {
    background:#e0f7f7;
  }
  .chat-list-item span {
    font-size:0.85rem; color:#555;
  }

  .chat-window {
    flex:1; display:flex; flex-direction:column; justify-content:space-between; min-height: 0;
  }
  .chat-messages { flex:1; padding:1rem; overflow-y:auto; scroll-behavior: smooth; min-height: 0;}
  /* Optional: nice scrollbar style */
  .chat-messages::-webkit-scrollbar {
    width: 6px;
  }
  .chat-messages::-webkit-scrollbar-thumb {
    background-color: #00A99D;
    border-radius: 3px;
  }
  .chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
  }
  .chat-message {
    margin-bottom:0.8rem; padding:0.6rem 1rem; border-radius:10px; max-width:80%;
  }
  .chat-message.admin { background:#0067A5; color:#fff; margin-left:auto; }
  .chat-message.student { background:#e8f5ff; color:#333; }

  .chat-input-area {
    display:flex; padding:0.8rem; border-top:1px solid #eee;
  }
  .chat-input-area input {
    flex:1; padding:0.6rem 1rem; border:1px solid #ccc;
    border-radius:20px; outline:none;
  }
  .chat-input-area button {
    margin-left:0.6rem; background:#0067A5; color:#fff;
    border:none; border-radius:50%; width:40px; height:40px;
    cursor:pointer; transition:0.3s;
  }
  .chat-input-area button:hover { background:#00A99D; }
  /* Hide chat button */
  .chatbot-btn.hidden {
    display: none;
  }

</style>
</head>
<body>

<!-- Navbar -->
<nav>
  <h1>SmartAssist</h1>
  <div class="nav-links">
    <a href="#">Home</a>
    <a href="#">Knowledge Base</a>
    <a href="#">Departments</a>
    <a href="#">Analytics</a>
    <a href="#">Users</a>
    <a href="login">Logout</a>
  </div>
</nav>

<!-- Main Layout -->
<div class="container">

  <div class="content">
    <div class="hero">
      <div>
        <h2>Welcome, Admin ðŸ‘‹</h2>
        <p>Manage knowledge base, departments, users, and view analytics at a glance.</p>
      </div>
      <img src="https://img.icons8.com/ios/200/ffffff/admin-settings-male.png" alt="Admin Illustration">
    </div>

    <div class="stats">
      <div class="stat"><div><div class="number">120</div><div class="label">Knowledge Articles</div></div><i class="fa-solid fa-book"></i></div>
      <div class="stat"><div><div class="number">15</div><div class="label">Departments</div></div><i class="fa-solid fa-building-columns"></i></div>
      <div class="stat"><div><div class="number">50</div><div class="label">Active Users</div></div><i class="fa-solid fa-user-gear"></i></div>
      <div class="stat"><div><div class="number">30</div><div class="label">Upcoming Appointments</div></div><i class="fa-solid fa-calendar-check"></i></div>
    </div>

    <div class="grid">
      <div class="card"><i class="fa-solid fa-book"></i><h3>Knowledge Base</h3><p>Add, edit, or remove FAQ articles and guides.</p></div>
      <div class="card"><i class="fa-solid fa-building-columns"></i><h3>Departments</h3><p>Update professor info, office locations, and departmental details.</p></div>
      <div class="card"><i class="fa-solid fa-chart-line"></i><h3>Analytics</h3><p>View reports on tickets, requests, and knowledge base usage.</p></div>
      <div class="card"><i class="fa-solid fa-user-gear"></i><h3>User Management</h3><p>Manage students, staff, and admin access and permissions.</p></div>
      <div class="card"><i class="fa-solid fa-calendar-check"></i><h3>Appointments</h3><p>View and manage scheduled appointments across departments.</p></div>
    </div>
  </div>
</div>

<!-- Floating Chat Button -->
<button class="chatbot-btn" id="chat-toggle"><i class="fa-solid fa-comments"></i></button>

<!-- Live Chat Panel -->
<div class="chat-panel" id="chat-panel">
  <div class="chat-header">
    <h3>Live Chat Requests</h3>
    <i class="fa-solid fa-xmark close-chat" id="close-chat"></i>
  </div>

  <div class="chat-body">
    <div class="chat-list" id="chat-list">
      <!-- Dynamic student list -->
    </div>

    <div class="chat-window">
      <div class="chat-messages" id="chat-messages">
        <p style="color:#999; text-align:center;">Select a chat to start messaging.</p>
      </div>
      <div class="chat-input-area">
        <input type="text" id="chat-input" placeholder="Type your message..." disabled>
        <button id="send-btn" disabled><i class="fa-solid fa-paper-plane"></i></button>
      </div>
    </div>
  </div>
</div>

<script>
const chatToggle = document.getElementById('chat-toggle');
const chatPanel = document.getElementById('chat-panel');
const closeChat = document.getElementById('close-chat');
const chatList = document.getElementById('chat-list');
const chatMessages = document.getElementById('chat-messages');
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');

let ws;
let selectedSession = null;

// Open/close panel
chatToggle.onclick = () => chatPanel.classList.toggle('open');
closeChat.onclick = () => chatPanel.classList.remove('open');

// ------------------- Helper Functions -------------------

// Add a student session to the list
function addSessionToList(sessionId, name) {
  const item = document.createElement('div');
  item.classList.add('chat-list-item');
  item.textContent = name + ' (' + sessionId.substring(0,4) + ')';
  item.onclick = () => selectSession(sessionId);
  item.dataset.id = sessionId;
  chatList.appendChild(item);
}

// Select a session to view messages
function selectSession(sessionId) {
  selectedSession = sessionId;
  chatMessages.innerHTML = '';
  chatInput.disabled = false;
  sendBtn.disabled = false;
  
  document.querySelectorAll('.chat-list-item').forEach(i => i.classList.remove('active'));
  document.querySelector(`.chat-list-item[data-id="${sessionId}"]`)?.classList.add('active');

  // Load chat history for this session
  fetch(`/api/admin/live_chats/${sessionId}`)
    .then(res => res.json())
    .then(data => {
      chatMessages.innerHTML = '';
      data.messages.forEach(msg => appendMessage(sessionId, msg.sender, msg.message));
    })
    .catch(err => console.error('Failed to load chat messages:', err));
}

// Append a message to the chat window
function appendMessage(sessionId, sender, message) {
  if (sessionId !== selectedSession) return; // Only show messages for selected session
  const div = document.createElement('div');
  div.classList.add('chat-message', sender === 'admin' ? 'admin' : 'student');
  div.textContent = message;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Open/close panel with chat button hide/show
chatToggle.onclick = () => {
  chatPanel.classList.add('open');
  chatToggle.classList.add('hidden'); // hide the button when panel opens
};

closeChat.onclick = () => {
  chatPanel.classList.remove('open');
  chatToggle.classList.remove('hidden'); // show the button when panel closes
};


// Send a message from admin
sendBtn.onclick = () => {
  const msg = chatInput.value.trim();
  if (!msg || !selectedSession) return;
  
  ws.send(JSON.stringify({ type: 'message', session_id: selectedSession, message: msg }));
  appendMessage(selectedSession, 'admin', msg);
  chatInput.value = '';
};

// ------------------- Load Existing Sessions -------------------

async function loadExistingSessions() {
  try {
    const res = await fetch('/api/admin/live_chats'); // Backend endpoint
    const sessions = await res.json(); // [{ session_id, name, messages: [{ sender, message }] }]
    
    sessions.forEach((session, idx) => {
      addSessionToList(session.session_id, session.name);
      
      // Auto-select the first session
      if (idx === 0) selectSession(session.session_id);
    });
  } catch (err) {
    console.error('Failed to load sessions:', err);
  }
}

// ------------------- WebSocket Connection -------------------

function connectWebSocket() {
  ws = new WebSocket(`ws://${window.location.host}/ws/admin`);

  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);

    if (data.type === 'new_session') {
      addSessionToList(data.session_id, data.name);
      if (!selectedSession) selectSession(data.session_id); // auto-select first
    } else if (data.type === 'message') {
      appendMessage(data.session_id, data.sender, data.message);
    }
  };

  ws.onopen = () => console.log("Connected to live chat WebSocket.");
  ws.onclose = () => console.log("Disconnected from live chat WebSocket.");
}

// ------------------- Initialize -------------------
window.onload = async () => {
  await loadExistingSessions(); // Load sessions and messages
  connectWebSocket();           // Start WebSocket for live updates
};
</script>

</body>
</html>
