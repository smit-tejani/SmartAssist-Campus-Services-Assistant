<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SmartAssist | Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins', sans-serif; }
  body { background:#f5f7fb; overflow-x:hidden; }

  /* Navbar */
  nav { display:flex; justify-content:space-between; align-items:center;
    padding:1rem 2rem; background:#0067A5; color:#fff; position:sticky; top:0; z-index:1000;
    box-shadow:0 2px 10px rgba(0,0,0,0.1); }
  nav h1 { font-size:1.6rem; font-weight:600; }
  nav .nav-links a { color:#fff; text-decoration:none; margin-left:1.5rem; font-weight:500; transition:0.3s; }
  nav .nav-links a:hover { color:#00A99D; }

  /* Container */
  .container { display:flex; min-height:calc(100vh - 70px); }
  .sidebar { width:250px; background:#fff; padding:2rem 1rem; border-right:1px solid #e0e0e0;
    display:flex; flex-direction:column; gap:1.5rem; position:sticky; top:70px; }
  .sidebar a { text-decoration:none; color:#0067A5; font-weight:500; padding:0.8rem 1rem; border-radius:8px;
    transition:0.3s; display:flex; align-items:center; gap:0.8rem; }
  .sidebar a:hover { background:#00A99D; color:#fff; }

  .content { flex:1; padding:2rem; display:flex; flex-direction:column; gap:2rem; }

  /* Hero Section */
  .hero { background:#00A99D; color:#fff; padding:2rem; border-radius:16px;
    display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;
    box-shadow:0 4px 20px rgba(0,0,0,0.1); }
  .hero h2 { font-size:1.8rem; margin-bottom:0.5rem; }
  .hero img { width:200px; max-width:100%; }

  /* Stats */
  .stats { display:flex; gap:1rem; flex-wrap:wrap; }
  .stat { flex:1; min-width:180px; background:#fff; padding:1rem 1.5rem; border-radius:12px;
    display:flex; align-items:center; justify-content:space-between;
    box-shadow:0 6px 20px rgba(0,0,0,0.05); transition:0.3s; }
  .stat:hover { transform:translateY(-5px); }

  /* Cards */
  .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:1.5rem; }
  .card { background:#fff; border-radius:16px; padding:1.5rem; box-shadow:0 6px 20px rgba(0,0,0,0.05);
    transition:0.4s; cursor:pointer; display:flex; flex-direction:column; justify-content:center; }
  .card:hover { transform:translateY(-8px); }
  .card i { font-size:2rem; color:#0067A5; margin-bottom:1rem; }

  /* Chatbot Button */
  .chatbot-btn {
    position:fixed; bottom:25px; right:25px; background:#0067A5; color:#fff;
    width:60px; height:60px; border-radius:50%; border:none;
    font-size:1.8rem; cursor:pointer; box-shadow:0 6px 20px rgba(0,0,0,0.2);
    transition:0.3s; z-index:1200;
  }
  .chatbot-btn:hover { background:#00A99D; }

  /* Live Chat Panel */
  .chat-panel {
    position:fixed; top:0; right:-450px; width:450px; height:100%;
    background:#fff; box-shadow:-3px 0 15px rgba(0,0,0,0.2);
    display:flex; flex-direction:column; transition:right 0.4s ease;
    z-index:1100;
  }
  .chat-panel.open { right:0; }

  .chat-header {
    background:#0067A5; color:#fff; padding:1rem; display:flex;
    justify-content:space-between; align-items:center;
  }
  .chat-header h3 { margin:0; font-size:1.1rem; }
  .close-chat { cursor:pointer; font-size:1.2rem; }

  .chat-body { flex:1; display:flex; min-height: 0;}
  .chat-list {
    width:40%; border-right:1px solid #eee; overflow-y:auto;
    background:#f8fafc;
  }
  .chat-list-item {
    padding:0.8rem; border-bottom:1px solid #eee; cursor:pointer;
    transition:0.2s;
  }
  .chat-list-item:hover, .chat-list-item.active {
    background:#e0f7f7;
  }
  .chat-list-item span {
    font-size:0.85rem; color:#555;
  }

  .chat-window {
    flex:1; display:flex; flex-direction:column; justify-content:space-between; min-height: 0;
  }
  .chat-messages { flex:1; padding:1rem; overflow-y:auto; scroll-behavior: smooth; min-height: 0;}
  /* Optional: nice scrollbar style */
  .chat-messages::-webkit-scrollbar {
    width: 6px;
  }
  .chat-messages::-webkit-scrollbar-thumb {
    background-color: #00A99D;
    border-radius: 3px;
  }
  .chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
  }
  .chat-message {
    margin-bottom:0.8rem; padding:0.6rem 1rem; border-radius:10px; max-width:80%;
  }
  .chat-message.admin { background:#0067A5; color:#fff; margin-left:auto; }
  .chat-message.student { background:#e8f5ff; color:#333; }

  .chat-input-area {
    display:flex; padding:0.8rem; border-top:1px solid #eee;
  }
  .chat-input-area input {
    flex:1; padding:0.6rem 1rem; border:1px solid #ccc;
    border-radius:20px; outline:none;
  }
  .chat-input-area button {
    margin-left:0.6rem; background:#0067A5; color:#fff;
    border:none; border-radius:50%; width:40px; height:40px;
    cursor:pointer; transition:0.3s;
  }
  .chat-input-area button:hover { background:#00A99D; }
  /* Hide chat button */
  .chatbot-btn.hidden {
    display: none;
  }

  /* Tickets & Appointments */
  /* ------------------- */
  /* Section */
  .tickets-appointments { margin-top:2rem; display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:1.5rem; }

  /* Cards */
  .ticket-card, .appointment-card {
    background:#fff; border-radius:16px; padding:1.5rem; box-shadow:0 6px 20px rgba(0,0,0,0.05);
    transition:0.4s; cursor:pointer; display:flex; flex-direction:column; justify-content:center;
  }
  .ticket-card:hover, .appointment-card:hover { transform:translateY(-8px); }
  .ticket-card i, .appointment-card i { font-size:2rem; color:#0067A5; margin-bottom:1rem; }

  /* Tables */
  table {
    width:100%; margin-top:1rem; border-collapse: collapse;
  }
  th, td {
    padding:0.8rem; text-align:left; border-bottom:1px solid #eee;
  }
  th {
    background:#f1f1f1; color:#333;
  }
  tr:hover {
    background:#f9f9f9;
  }

  /* Modal */
  #ticket-modal {
    display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:2000;
  }
  #ticket-modal > div {
    background:#fff; border-radius:12px; padding:2rem; width:500px; max-width:90%; max-height:90%; overflow-y:auto; position:relative;
  }
  #close-ticket-modal {
    position:absolute; top:1rem; right:1rem; cursor:pointer; font-size:1.2rem;
  }
  #ticket-subject {
    margin:0 0 1rem 0;
    font-size:1.3rem; font-weight:500;
  }
  #ticket-status, #ticket-assign {
    width:100%; padding:0.6rem; border:1px solid #ccc;
    border-radius:6px; margin-top:0.5rem;
  }
  #update-ticket {
    background:#00A99D; color:white; padding:0.6rem 1.2rem; border:none; border-radius:6px;
    cursor:pointer; transition:0.3s; margin-top:1rem;
  }
  #update-ticket:hover {
    background:#009688;
  }

  .ticket-item, .appointment-item {
    background:#fdfdfd;
    box-shadow:0 3px 10px rgba(0,0,0,0.05);
    transition:0.3s;
  }
  .ticket-item:hover, .appointment-item:hover {
    transform:translateY(-3px);
  }
  .ticket-item button, .appointment-item button {
    background:#0067A5; color:#fff; border:none; padding:0.4rem 0.8rem; border-radius:6px; cursor:pointer;
  }
  .ticket-item button:hover, .appointment-item button:hover {
    background:#00A99D;
  }
</style>
</head>
<body>

<!-- Navbar -->
<nav>
  <h1>SmartAssist</h1>
  <div class="nav-links">
    <a href="#">Home</a>
    <a href="#">Knowledge Base</a>
    <a href="#">Departments</a>
    <a href="#">Analytics</a>
    <a href="#">Users</a>
    <a href="login">Logout</a>
  </div>
</nav>

<!-- Main Layout -->
<div class="container">

  <div class="content">
    <div class="hero">
      <div>
        <h2>Welcome, Admin ðŸ‘‹</h2>
        <p>Manage knowledge base, departments, users, and view analytics at a glance.</p>
      </div>
      <img src="https://img.icons8.com/ios/200/ffffff/admin-settings-male.png" alt="Admin Illustration">
    </div>

    <div class="stats">
      <div class="stat"><div><div class="number">0</div><div class="label">Knowledge Articles</div></div><i class="fa-solid fa-book"></i></div>
      <div class="stat"><div><div class="number">0</div><div class="label">Departments</div></div><i class="fa-solid fa-building-columns"></i></div>
      <div class="stat"><div><div class="number">0</div><div class="label">Active Users</div></div><i class="fa-solid fa-user-gear"></i></div>
      <div class="stat"><div><div class="number">0</div><div class="label">Upcoming Appointments</div></div><i class="fa-solid fa-calendar-check"></i></div>
    </div>

    <div class="grid">
      <a href="/knowledge_base" style="text-decoration: none; color: inherit;">
        <div class="card">
          <i class="fa-solid fa-book"></i>
          <h3>Knowledge Base</h3>
          <p>Add, edit, or remove FAQ articles and guides.</p>
        </div>
      </a>
      <div class="card"><i class="fa-solid fa-building-columns"></i><h3>Departments</h3><p>Update professor info, office locations, and departmental details.</p></div>
      <div class="card"><i class="fa-solid fa-chart-line"></i><h3>Analytics</h3><p>View reports on tickets, requests, and knowledge base usage.</p></div>
      <div class="card"><i class="fa-solid fa-user-gear"></i><h3>User Management</h3><p>Manage students, staff, and admin access and permissions.</p></div>
      <div class="card"><i class="fa-solid fa-calendar-check"></i><h3>Appointments</h3><p>View and manage scheduled appointments across departments.</p></div>
    </div>

    <!-- Tickets & Appointments Section -->
    <div class="grid" style="margin-top:2rem;">

      <!-- Tickets Card -->
      <div class="card" style="flex:2; min-width:400px;">
        <i class="fa-solid fa-ticket"></i>
        <h3>Open Tickets</h3>
        <p>View, assign, and manage student-raised tickets.</p>

        <table style="width:100%; margin-top:1rem; border-collapse: collapse;">
          <thead>
            <tr style="background:#00A99D; color:white;">
              <th style="padding:0.5rem; text-align:left;">ID</th>
              <th style="padding:0.5rem; text-align:left;">Student</th>
              <th style="padding:0.5rem; text-align:left;">Subject</th>
              <th style="padding:0.5rem; text-align:left;">Status</th>
              <th style="padding:0.5rem; text-align:left;">Assign</th>
            </tr>
          </thead>
          <tbody id="tickets-table">
            <!-- Tickets dynamically populated here -->
          </tbody>
        </table>
      </div>

      <!-- Appointments Card -->
      <div class="card" style="flex:2; min-width:400px;">
        <i class="fa-solid fa-calendar-check"></i>
        <h3>Upcoming Appointments</h3>
        <p>View and manage all scheduled appointments.</p>

        <table style="width:100%; margin-top:1rem; border-collapse: collapse;">
          <thead>
            <tr style="background:#0067A5; color:white;">
              <th style="padding:0.5rem; text-align:left;">ID</th>
              <th style="padding:0.5rem; text-align:left;">Student</th>
              <th style="padding:0.5rem; text-align:left;">Department</th>
              <th style="padding:0.5rem; text-align:left;">Date & Time</th>
              <th style="padding:0.5rem; text-align:left;">Status</th>
            </tr>
          </thead>
          <tbody id="appointments-table">
            <!-- Appointments dynamically populated here -->
          </tbody>
        </table>
      </div>

    </div>

    <!-- Ticket Details Modal -->
    <div id="ticket-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:2000;">
      <div style="background:#fff; border-radius:12px; padding:2rem; width:500px; max-width:90%; max-height:90%; overflow-y:auto; position:relative;">
        <span id="close-ticket-modal" style="position:absolute; top:1rem; right:1rem; cursor:pointer; font-size:1.2rem;">&times;</span>
        <h3 id="ticket-subject">Ticket Subject</h3>
        <p><strong>Student:</strong> <span id="ticket-student"></span></p>
        <p><strong>Category:</strong> <span id="ticket-category"></span></p>
        <p><strong>Priority:</strong> <span id="ticket-priority"></span></p>
        <p><strong>Description:</strong></p>
        <p id="ticket-description"></p>
        <p><strong>Status:</strong>
          <select id="ticket-status">
            <option value="Open">Open</option>
            <option value="In Progress">In Progress</option>
            <option value="Closed">Closed</option>
          </select>
        </p>
        <p><strong>Assign Staff:</strong>
          <select id="ticket-assign">
            <!-- Staff list populated dynamically -->
          </select>
        </p>
        <button id="update-ticket" style="background:#00A99D; color:white; padding:0.5rem 1rem; border:none; border-radius:6px; cursor:pointer;">Update Ticket</button>
      </div>
    </div>

  </div>
</div>

<!-- Floating Chat Button -->
<button class="chatbot-btn" id="chat-toggle"><i class="fa-solid fa-comments"></i></button>

<!-- Live Chat Panel -->
<div class="chat-panel" id="chat-panel">
  <div class="chat-header">
    <h3>Live Chat Requests</h3>
    <i class="fa-solid fa-xmark close-chat" id="close-chat"></i>
  </div>

  <div class="chat-body">
    <div class="chat-list" id="chat-list">
      <!-- Dynamic student list -->
    </div>

    <div class="chat-window">
      <div class="chat-messages" id="chat-messages">
        <p style="color:#999; text-align:center;">Select a chat to start messaging.</p>
      </div>
      <div class="chat-input-area">
        <input type="text" id="chat-input" placeholder="Type your message..." disabled>
        <button id="send-btn" disabled><i class="fa-solid fa-paper-plane"></i></button>
      </div>
    </div>
  </div>
</div>

<script>
const chatToggle = document.getElementById('chat-toggle');
const chatPanel = document.getElementById('chat-panel');
const closeChat = document.getElementById('close-chat');
const chatList = document.getElementById('chat-list');
const chatMessages = document.getElementById('chat-messages');
const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-btn');

let ws;
let selectedSession = null;
const joinedSessions = new Set();      // sessions this admin has joined
const sessionsIndex  = new Map();      // session_id -> {name,status}


// Open/close panel with chat button hide/show
chatToggle.onclick = () => {
  chatPanel.classList.add('open');
  chatToggle.classList.add('hidden'); // hide the button when panel opens
};

closeChat.onclick = () => {
  chatPanel.classList.remove('open');
  chatToggle.classList.remove('hidden'); // show the button when panel closes
};

// ------------------- Helper Functions -------------------
function fallbackName(sessionId, name) {
  return name && name.trim() ? name : `Student ${sessionId?.slice(0,4) || ''}`;
}

function upsertSession(session) {
  const sid = session.session_id;
  const name = fallbackName(sid, session.name);
  const status = session.status || 'queued';

  // store/merge local model
  const prev = sessionsIndex.get(sid) || {};
  sessionsIndex.set(sid, { name: name || prev.name, status });

  // dedupe list item by data-id
  let item = chatList.querySelector(`.chat-list-item[data-id="${sid}"]`);
  if (!item) {
    item = document.createElement('div');
    item.classList.add('chat-list-item');
    item.dataset.id = sid;
    item.onclick = () => selectSession(sid);
    chatList.appendChild(item);
  }
  item.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>${fallbackName(sid, name)} <span style="color:#777">(${sid.slice(0,4)})</span></div>
      <span style="font-size:.7rem;padding:.1rem .4rem;border-radius:8px;background:${status==='live'?'#d1f7e6':'#fff3cd'};color:${status==='live'?'#0b6848':'#8a6d3b'};">
        ${status}
      </span>
    </div>
  `;
}

function clearMessages() {
  chatMessages.innerHTML = `<p style="color:#999; text-align:center;">Select a chat to start messaging.</p>`;
}

function removeSession(sessionId) {
  const item = chatList.querySelector(`.chat-list-item[data-id="${sessionId}"]`);
  if (item) item.remove();
  if (selectedSession === sessionId) {
    selectedSession = null;
    chatInput.disabled = true; sendBtn.disabled = true;
    chatMessages.innerHTML = `<p style="color:#999; text-align:center;">Select a chat to start messaging.</p>`;
  }
  sessionsIndex.delete(sessionId);
  joinedSessions.delete(sessionId);
}



function enableInput(enabled) {
  chatInput.disabled = !enabled;
  sendBtn.disabled   = !enabled;
}

// ---------- Select a session ----------
async function selectSession(sessionId) {
  selectedSession = sessionId;
  document.querySelectorAll('.chat-list-item').forEach(i => i.classList.remove('active'));
  document.querySelector(`.chat-list-item[data-id="${sessionId}"]`)?.classList.add('active');

  // reset window
  chatMessages.innerHTML = '';
  enableInput(false);

  // 1) Load chat history (backend: GET /api/chat/{session_id} returns a LIST)
  try {
    const res = await fetch(`/api/chat/${sessionId}`);
    const history = await res.json(); // [{sender, message, created_at}, ...]
    if (!Array.isArray(history)) throw new Error('Bad history payload');
    history.forEach(msg => appendMessage(sessionId, msg.sender, msg.message));
  } catch (err) {
    console.error('Failed to load chat messages:', err);
  }

  // 2) JOIN the session once per admin per session
  if (!joinedSessions.has(sessionId)) {
    ws?.send(JSON.stringify({ type: 'join', session_id: sessionId }));
    // wait for "joined" event to enable input
  } else {
    enableInput(true);
  }
}

// ---------- Load existing sessions on page load ----------
// Append a message to the chat window
function appendMessage(sessionId, sender, message) {
  if (sessionId !== selectedSession) return; // only show for selected session
  const div = document.createElement('div');
  div.classList.add('chat-message', sender === 'admin' ? 'admin' : 'student');
  div.textContent = message;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// ---------- Send a message ----------
sendBtn.onclick = () => {
  const msg = chatInput.value.trim();
  if (!msg || !selectedSession) return;

  if (!joinedSessions.has(selectedSession)) {
    // safety: do not allow sending before joined
    return alert('Join the session first.');
  }

  ws.send(JSON.stringify({ type: 'message', session_id: selectedSession, message: msg }));
  appendMessage(selectedSession, 'admin', msg);
  chatInput.value = '';
};

// ---------- Load existing sessions on page load ----------
async function loadExistingSessions() {
  try {
    const res = await fetch('/api/admin/live_chats'); // returns [{session_id, status, name?}]
    const sessions = await res.json();
    sessions.forEach((s, idx) => {
      upsertSession(s);
      if (idx === 0) selectSession(s.session_id);
    });
  } catch (err) {
    console.error('Failed to load sessions:', err);
  }
}

// ---------- Admin WebSocket ----------
function connectWebSocket() {
  ws = new WebSocket(`${location.origin.replace('http', 'ws')}/ws/admin`);

  ws.onopen = () => console.log("Connected to live chat WebSocket.");
  ws.onclose = () => console.log("Disconnected from live chat WebSocket.");

  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);

    if (data.type === 'new_session') {
      // session (queued) appears to admins
      upsertSession({ session_id: data.session_id, status: data.status || 'queued', name: data.name });
      if (!selectedSession) selectSession(data.session_id);
      return;
    }

    if (data.type === 'queued_ping') {
      // student typed while queued â€” keep as lightweight activity marker
      return;
    }

    if (data.type === 'joined') {
      // this admin successfully joined a session â†’ enable input
      if (data.session_id) {
        joinedSessions.add(data.session_id);
        upsertSession({ session_id: data.session_id, status: 'live' });
        if (selectedSession === data.session_id) enableInput(true);
      }
      return;
    }

    if (data.type === 'error') {
      console.warn('WS error:', data.reason);
      return;
    }

    if (data.type === 'message') {
      // Only messages for selected session are appended by appendMessage()
      appendMessage(data.session_id, data.sender, data.message);
      return;
    }

    if (data.type === 'session_removed') {
      removeSession(data.session_id);
      return;
    }

  };
}

// ------------------- Initialize -------------------
window.onload = async () => {
  await loadExistingSessions(); // Load sessions and messages
  clearMessages();
  connectWebSocket();           // Start WebSocket for live updates
  loadTickets();               // Load tickets for admin
  loadAppointments();           // Load appointments for admin
};

// ------------------- Tickets & Appointments -------------------
// Load tickets from server
async function loadTickets() {
  try {
    console.log('Fetching tickets from backend...');
    const res = await fetch('/api/tickets'); // Ensure this endpoint matches your backend
    if (!res.ok) {
      console.error(`Failed to fetch tickets. Status: ${res.status}, Message: ${res.statusText}`);
      return;
    }
    const data = await res.json();
    console.log('Tickets fetched:', data);

    const tickets = data.tickets || []; // Extract tickets array from response
    const ticketsTable = document.getElementById('tickets-table');
    ticketsTable.innerHTML = '';

    tickets.forEach(ticket => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${ticket.id}</td>
        <td>${ticket.student_name}</td>
        <td>${ticket.subject}</td>
        <td>${ticket.status}</td>
        <td>
          <button class="assign-btn" style="margin-right:0.5rem;">Assign</button>
          <button class="update-status-btn">Update</button>
        </td>
      `;

      // Assign Staff click
      row.querySelector('.assign-btn').onclick = () => openTicketModal(ticket);
      row.querySelector('.update-status-btn').onclick = () => openTicketModal(ticket);

      ticketsTable.appendChild(row);
    });
  } catch (err) {
    console.error('Error fetching tickets:', err);
  }
}

// Load appointments from server
async function loadAppointments() {
  try {
    console.log('Fetching appointments from backend...');
    const res = await fetch('/api/appointments'); // Ensure this endpoint matches your backend
    if (!res.ok) {
      console.error(`Failed to fetch appointments. Status: ${res.status}, Message: ${res.statusText}`);
      return;
    }
    const data = await res.json();
    console.log('Appointments fetched:', data);

    const appointments = data.appointments || []; // Extract appointments array from response
    const appointmentsTable = document.getElementById('appointments-table');
    appointmentsTable.innerHTML = '';
    
    appointments.forEach(app => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${app.id}</td>
        <td>${app.student_name}</td>
        <td>${app.department}</td>
        <td>${app.date} ${app.time}</td>
        <td>${app.status}</td>
      `;

      appointmentsTable.appendChild(row);
    });
  } catch (err) {
    console.error('Error fetching appointments:', err);
  }
}

// Ticket modal functions
const ticketModal = document.getElementById('ticket-modal');
const closeTicketModal = document.getElementById('close-ticket-modal');
closeTicketModal.onclick = () => ticketModal.style.display = 'none';

function openTicketModal(ticket) {
  ticketModal.style.display = 'flex';
  document.getElementById('ticket-subject').textContent = ticket.subject;
  document.getElementById('ticket-student').textContent = ticket.student_name;
  document.getElementById('ticket-category').textContent = ticket.category;
  document.getElementById('ticket-priority').textContent = ticket.priority;
  document.getElementById('ticket-description').textContent = ticket.description;
  document.getElementById('ticket-status').value = ticket.status;

  const assignSelect = document.getElementById('ticket-assign');
  assignSelect.innerHTML = '';
  ticket.staff_list.forEach(staff => {
    const option = document.createElement('option');
    option.value = staff;
    option.textContent = staff;
    if(ticket.assigned_staff === staff) option.selected = true;
    assignSelect.appendChild(option);
  });

  document.getElementById('update-ticket').onclick = async () => {
    const updatedStatus = document.getElementById('ticket-status').value;
    const assignedStaff = document.getElementById('ticket-assign').value;

    try {
      await fetch(`/api/tickets/${ticket.id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: updatedStatus, assigned_staff: assignedStaff })
      });
      ticketModal.style.display = 'none';
      loadTickets(); // refresh table
    } catch (err) {
      console.error('Failed to update ticket:', err);
    }
  }
}

// Initialize
window.onload = () => {
  loadTickets();
  loadAppointments();
};

document.addEventListener('DOMContentLoaded', async () => {
  console.log('DOM fully loaded and parsed. Fetching stats...');

  try {
    const res = await fetch('/api/stats');
    if (res.ok) {
      const stats = await res.json();
      console.log('Stats fetched successfully:', stats);

      const knowledgeArticlesStat = document.querySelector('.stat .number');
      if (knowledgeArticlesStat) {
        knowledgeArticlesStat.textContent = stats.knowledge_articles || 0;
        console.log('Knowledge articles count updated in UI:', stats.knowledge_articles);
      } else {
        console.error('Knowledge articles stat element not found in the DOM.');
      }
    } else {
      console.error(`Failed to fetch stats. Status: ${res.status}`);
    }
  } catch (err) {
    console.error('Error fetching stats:', err);
  }
});
</script>

</body>
</html>
